
<div class="app">
  <app-sidebar [user]="auth.getCurrentUser()" [sidebarOpen]="sidebarOpen"></app-sidebar>
  <main class="main">
    <header class="topbar" role="banner">
      <button id="menuToggle" class="menu-btn" aria-label="Abrir menu" (click)="toggleSidebar()">☰</button>
      
      <div class="user-actions">
        <button class="btn primary" (click)="sair()">Sair</button>
      </div>
    </header>
    <section class="content" aria-live="polite">
      <div class="dashboard-content">
        <div class="dashboard-grid">
          <!-- Card: Guia de Integração TrustPay -->
          <div class="dashboard-card">
            <h2>Como usar a API TrustPay</h2>
            <p class="text-sm text-muted-foreground">Siga os passos abaixo para integrar sua aplicação à API TrustPay:</p>
            <ol class="text-sm" style="margin-bottom:1rem;">
              <li><strong>Autenticação:</strong> Use os headers <code>x-api-key</code>, <code>x-timestamp</code> e <code>x-signature</code> em todas as requisições protegidas.</li>
              <li><strong>Headers obrigatórios:</strong>
                <ul>
                  <li><code>x-api-key</code>: sua chave pública (merchantKey)</li>
                  <li><code>x-timestamp</code>: data/hora em segundos (epoch)</li>
                  <li><code>x-signature</code>: assinatura HMAC-SHA256 do payload</li>
                  <li><code>Content-Type</code>: <code>application/json</code></li>
                </ul>
              </li>
              <li><strong>Formato da assinatura:</strong> Concatene <code>METHOD</code>, <code>PATH</code>, <code>TIMESTAMP</code> e <code>RAW_BODY</code> separados por quebras de linha (<code>\n</code>), e gere o HMAC usando sua <code>merchantSecret</code>.</li>
              <li><strong>Fluxo básico:</strong>
                <ul>
                  <li>1. Gere os headers usando suas chaves merchant.</li>
                  <li>2. Envie a requisição para o endpoint desejado.</li>
                  <li>3. Receba a resposta e trate conforme a documentação.</li>
                </ul>
              </li>
             <li><strong>Exemplo de endpoint:</strong> <code>POST /api/merchant/v1/payment-intents</code> para criar uma intenção de pagamento.</li>
             
            </ol>
            <h2>Endpoints essenciais</h2>
            <p class="text-sm text-muted-foreground">Base local: <code>http://localhost:3000/api/merchant/v1</code></p>
            <ul class="text-sm">
              <li><strong>POST</strong> <code>/payment-intents</code> — cria intenção</li>
              <li><strong>POST</strong> <code>/payments/:id/capture</code> — captura cartão</li>
              <li><strong>POST</strong> <code>/payments/:id/pix</code> — inicia PIX</li>
              <li><strong>GET</strong> <code>/payments/:id/status</code> — status</li>
              <li><strong>POST</strong> <code>/payments/:id/refund</code> — reembolso</li>
            </ul>
            <div class="alert alert-info">Consulte a documentação completa para detalhes de cada endpoint, parâmetros e exemplos de resposta.</div>
          </div>
          <!-- Card: Gerar Headers HMAC -->
          <div class="dashboard-card">
            <h2>Visualizar Chaves Merchant</h2>
            <p class="text-sm text-muted-foreground">Guia direto: gere os headers necessários e envie sua requisição.</p>
            <div class="actions" style="flex-direction:column; align-items:flex-start; gap: 0.75rem; flex-wrap: wrap;">
              <button class="btn btn-primary mb-2" type="button" (click)="toggleMostrarChaves()">
                {{ mostrarChaves ? 'Ocultar Chaves' : 'Mostrar Chaves' }}
              </button>
              <div style="display:flex; gap:2rem; align-items:flex-start; margin-bottom:0.5rem;">
                <div style="min-width:220px;">
                  <label class="fw-bold">Merchant Key:</label>
                  <pre class="bg-light p-2 border rounded">{{ mostrarChaves ? (merchantKey || 'Chave não encontrada') : '********-*************-****' }}</pre>
                  <label class="fw-bold">Merchant Secret:</label>
                  <pre class="bg-light p-2 border rounded">{{ mostrarChaves ? (merchantSecret || 'Chave não encontrada') : '******************************' }}</pre>
                  <div *ngIf="mostrarChaves && (!merchantKey || !merchantSecret)" class="alert alert-warning mt-2">Chaves merchant não encontradas para este usuário.</div>
                </div>
              </div>
              <h2>Gear Headers e Payloads para testes</h2>
              <div style="display:flex; gap:0.5rem; flex-wrap:wrap; align-items:center;">
                <label for="routeSelect" class="form-label">Rota:</label>
                <select id="routeSelect" [(ngModel)]="selectedRoute" class="form-select" style="max-width:180px; margin-right:8px;">
                  <option value="intents">Criar Intent</option>
                  <option value="capture">Capturar Pagamento</option>
                </select>
                <label for="payloadSelect" class="form-label">Payload:</label>
                <select id="payloadSelect" [(ngModel)]="selectedPayloadType" class="form-select" style="max-width:180px; margin-right:8px;">
                  <option *ngFor="let opt of payloadOptions" [value]="opt.value">{{ opt.label }}</option>
                </select>
                <ng-container *ngIf="selectedRoute === 'capture'">
                  <label for="paymentId" class="form-label">ID do Pagamento:</label>
                  <input id="paymentId" [(ngModel)]="paymentId" class="form-control" style="max-width:180px; margin-right:8px;" placeholder="ID do intent" />
                </ng-container>
                <button class="btn-primary" type="button" (click)="preencherHeaders()">Gerar headers</button>
                <button class="btn-success" type="button" (click)="testarEndpoint()">Testar</button>
              </div>
            </div>
            <div>
              <label class="form-label">Headers gerados</label>
              <pre class="code-block">{{ headersText && headersText.trim() ? headersText : '******************************' }}</pre>
              <label class="form-label mt-2">Payload selecionado</label>
              <pre class="code-block">{{ headersText && headersText.trim() ? (selectedPayload | json) : '******************************' }}</pre>
            </div>
          </div>
         </div>
      </div>
    </section>
  </main>
</div>
